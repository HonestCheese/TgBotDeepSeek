import re
import time
from datetime import datetime

import telebot
import json
from config import TELEGRAM_TOKEN
from database import TaskDatabase
from deepseek import DeepSeekClient


class TaskBot:
    def __init__(self):
        print("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞...")

        self.bot = telebot.TeleBot(TELEGRAM_TOKEN)
        self.db = TaskDatabase()
        self.ds = DeepSeekClient()
        print("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")

        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        self.register_handlers()

    def register_handlers(self):
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""

        @self.bot.message_handler(func=lambda message: True)
        def handle_intent(message):
            user_id = message.from_user.id
            user_message = message.text

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç..." —Å—Ä–∞–∑—É
            self.bot.send_chat_action(message.chat.id, 'typing')

            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            current_tasks = self.db.get_user_tasks(user_id)

            # –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –∑–∞–ø—Ä–æ—Å –∫ DeepSeek (–∞–Ω–∞–ª–∏–∑ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
            unified_prompt = f"""
            –¢–´ - –ê–°–°–ò–°–¢–ï–ù–¢ –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–î–ê–ß–ê–ú–ò.
            –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–µ–π—á–∞—Å: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}

            ========== –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï ==========
            –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{user_message}"

            –¢–ï–ö–£–©–ò–ï –ó–ê–î–ê–ß–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: 1-–≤—ã—Å–æ–∫–∏–π, 2-—Å—Ä–µ–¥–Ω–∏–π, 3-–Ω–∏–∑–∫–∏–π):
            {current_tasks}
            =====================================

            ========== –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ê–ù–ê–õ–ò–ó–£ ==========
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¢–†–ò –¥–µ–π—Å—Ç–≤–∏—è:
            1. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JSON —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Å—Ç—Ä–æ–≥–æ –ø–æ —Ñ–æ—Ä–º–∞—Ç—É)
            2. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            3. JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–ï–†–í–´–ú, –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é - –í–¢–û–†–´–ú

            ========== –í–°–ï –î–û–°–¢–£–ü–ù–´–ï –ù–ê–ú–ï–†–ï–ù–ò–Ø ==========
            1. add_task - –î–û–ë–ê–í–ò–¢–¨ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
               - –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –¥–æ–±–∞–≤—å, —Å–æ–∑–¥–∞–π, –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –∑–∞–ø–∏—à–∏, –Ω–∞–ø–æ–º–Ω–∏, –∫—É–ø–∏—Ç—å, —Å–¥–µ–ª–∞—Ç—å, —Ç–∞–∫–∂–µ, –µ—â–µ
               - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ data: "task" (—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏)
               - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è: "deadline" (–¥–∞—Ç–∞/–≤—Ä–µ–º—è), "priority" (1/2/3)

            2. complete_task - –û–¢–ú–ï–¢–ò–¢–¨ –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
               - –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: —Å–¥–µ–ª–∞–Ω–æ, –≥–æ—Ç–æ–≤–æ, –≤—ã–ø–æ–ª–Ω–µ–Ω–æ, –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –∑–∞–∫–æ–Ω—á–∏–ª, –æ—Ç–º–µ—Ç–∫–∞
               - –ü–æ–ª—è –≤ data: –ò–õ–ò "task_id" (—á–∏—Å–ª–æ) –ò–õ–ò "task_text" (—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏)

            3. delete_task - –£–î–ê–õ–ò–¢–¨ –∑–∞–¥–∞—á—É
               - –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: —É–¥–∞–ª–∏, —É–±–µ—Ä–∏, —É–¥–∞–ª–∏—Ç—å, –≤—ã–∫–∏–Ω—å, –∏–∑–±–∞–≤—å—Å—è
               - –ü–æ–ª—è –≤ data: –ò–õ–ò "task_id" (—á–∏—Å–ª–æ) –ò–õ–ò "task_text" (—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏)

            4. update_task - –ò–ó–ú–ï–ù–ò–¢–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–¥–∞—á—É
               - –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –∏–∑–º–µ–Ω–∏, –æ–±–Ω–æ–≤–∏, –ø–æ–º–µ–Ω—è–π, –ø–µ—Ä–µ–∏–º–µ–Ω—É–π, –ø–µ—Ä–µ–¥–≤–∏–Ω—å, –ø–µ—Ä–µ–Ω–µ—Å–∏, –∏—Å–ø—Ä–∞–≤—å
               - –í data –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ò–õ–ò "task_id" –ò–õ–ò "task_text" (—á—Ç–æ –∏—â–µ–º)
               - –í data –í–°–ï –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å (–≤–∫–ª—é—á–∞—è task_text, priority, deadline, status, progress_context –∏ —Ç.–¥.)
               - DeepSeek, –í–ù–ò–ú–ê–ù–ò–ï: —Ç—ã –ø–µ—Ä–µ–¥–∞–µ—à—å –ü–û–õ–ù–û–°–¢–¨–Æ –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –æ–±—ä–µ–∫—Ç –∑–∞–¥–∞—á–∏!

            5. show_tasks - –ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –∑–∞–¥–∞—á–∏ (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫)
               - –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –ø–æ–∫–∞–∂–∏ –≤—Å–µ, —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á, –º–æ–∏ –∑–∞–¥–∞—á–∏, —á—Ç–æ —É –º–µ–Ω—è
               - –ü–æ–ª—è –≤ data: –ø—É—Å—Ç–æ ({{}})

            6. show_task_info - –ü–û–ö–ê–ó–ê–¢–¨ –î–ï–¢–ê–õ–¨–ù–£–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–µ
               - –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ, –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏, —á—Ç–æ –∑–∞ –∑–∞–¥–∞—á–∞, –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ, —Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∑–∞–¥–∞—á—É
               - –ü–æ–ª—è –≤ data: –ò–õ–ò "task_id" –ò–õ–ò "task_text"

            7. show_context - –ü–û–ö–ê–ó–ê–¢–¨ –¢–û–õ–¨–ö–û –ö–û–ù–¢–ï–ö–°–¢/–ü–†–û–ì–†–ï–°–° –∑–∞–¥–∞—á–∏
               - –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏, –ø—Ä–æ–≥—Ä–µ—Å—Å, —á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –ø–æ, —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –∫–∞–∫ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è
               - –ü–æ–ª—è –≤ data: –ò–õ–ò "task_id" –ò–õ–ò "task_text"

            8. stats - –ü–û–ö–ê–ó–ê–¢–¨ –°–¢–ê–¢–ò–°–¢–ò–ö–£ –ø–æ –∑–∞–¥–∞—á–∞–º
               - –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á, –æ—Ç—á–µ—Ç, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, —Å–∫–æ–ª—å–∫–æ —Å–¥–µ–ª–∞–Ω–æ
               - –ü–æ–ª—è –≤ data: –ø—É—Å—Ç–æ ({{}})

            9. chat - –ü–†–û–°–¢–û–ï –û–ë–©–ï–ù–ò–ï (–µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∑–∞–¥–∞—á–∞–º)
               - –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –æ–±—â–∞–µ—Ç—Å—è, –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –Ω–µ –ø–æ –∑–∞–¥–∞—á–∞–º
               - –í–µ–¥–∏ —Å–µ–±—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π DeepSeek-—á–∞—Ç

            ========== –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê ==========
            1. –ù–ï–°–ö–û–õ–¨–ö–û –î–ï–ô–°–¢–í–ò–ô: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—á–∏—Å–ª—è–µ—Ç —á–µ—Ä–µ–∑ "–∏", ",", "—Ç–∞–∫–∂–µ", "–µ—â–µ" - —Å–æ–∑–¥–∞–π –û–¢–î–ï–õ–¨–ù–´–ô action –¥–ª—è –ö–ê–ñ–î–û–ì–û –¥–µ–π—Å—Ç–≤–∏—è
               –ü—Ä–∏–º–µ—Ä: "–¥–æ–±–∞–≤–∏—Ç—å –º–æ–ª–æ–∫–æ –∏ —É–¥–∞–ª–∏—Ç—å —Ö–ª–µ–±" -> –¥–≤–∞ actions: add_task –∏ delete_task

            2. –ü–û–†–Ø–î–û–ö –î–ï–ô–°–¢–í–ò–ô: –î–µ–π—Å—Ç–≤–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ç–æ–º –ø–æ—Ä—è–¥–∫–µ, –∫–∞–∫ –≤ –º–∞—Å—Å–∏–≤–µ actions
               - show_tasks –í–°–ï–ì–î–ê –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–°–õ–ï–î–ù–ò–ú –≤ –º–∞—Å—Å–∏–≤–µ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ)

            3. –ü–û–ò–°–ö –ó–ê–î–ê–ß: –ï—Å–ª–∏ task_text —É–∫–∞–∑–∞–Ω, –∏—â–∏ –ü–û–•–û–ñ–ò–ô —Ç–µ–∫—Å—Ç (–Ω–µ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
               - –î–ª—è delete/complete: –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å/–æ—Ç–º–µ—Ç–∏—Ç—å –±–ª–∏–∂–∞–π—à—É—é –ø–æ —Å–º—ã—Å–ª—É, –µ—Å–ª–∏ —Ç–æ—á–Ω–æ–π –Ω–µ—Ç

            4. –ú–ê–°–°–û–í–´–ï –û–ü–ï–†–ê–¶–ò–ò: "—É–¥–∞–ª–∏ –≤—Å–µ –∑–∞–¥–∞—á–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º 2" -> —Å–æ–∑–¥–∞–π –û–¢–î–ï–õ–¨–ù–´–ô delete_task –¥–ª—è –ö–ê–ñ–î–û–ô –ø–æ–¥—Ö–æ–¥—è—â–µ–π –∑–∞–¥–∞—á–∏

            5. –†–ê–ó–î–ï–õ–ï–ù–ò–ï –ù–ê–ó–í–ê–ù–ò–Ø –ò –ö–û–ù–¢–ï–ö–°–¢–ê:
               - –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–∫–æ—Ä–æ—Ç–∫–æ–µ, —Å—É—Ç—å) ‚Üí task_text
               - –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, –ø—Ä–æ–≥—Ä–µ—Å—Å, —É—Ç–æ—á–Ω–µ–Ω–∏—è ‚Üí progress_context

            6. update_task –í–ê–ñ–ù–û: –¢—ã –ø–µ—Ä–µ–¥–∞–µ—à—å –í–°–ï –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ë–´–¢–¨ –≤ –∑–∞–¥–∞—á–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
               - –ù–µ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ, –∞ –ü–û–õ–ù–û–°–¢–¨–Æ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–¥–∞—á–∏
               - –ü—Ä–∏–º–µ—Ä: –±—ã–ª–æ "–∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ", –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ "–∫—É–ø–∏—Ç—å —Ö–ª–µ–±" –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ 1
                 ‚Üí data: {{"task_id": 5, "task_text": "–∫—É–ø–∏—Ç—å —Ö–ª–µ–±", "priority": 1, "status": 1, ...}}

            ========== –§–û–†–ú–ê–¢ JSON –û–¢–í–ï–¢–ê ==========
            [json]
            {{"actions": [
                {{
                    "intent": "add_task",
                    "data": {{
                        "task": "—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏",
                        "deadline": "2025-02-20 18:00",
                        "priority": 1
                    }}
                }},
                {{
                    "intent": "complete_task", 
                    "data": {{
                        "task_id": 5
                    }}
                }}
            ]}}
            [/json]

            ========== –ü–†–ò–ú–ï–†–´ JSON –î–õ–Ø –†–ê–ó–ù–´–• –°–õ–£–ß–ê–ï–í ==========
            1. –î–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω—É –∑–∞–¥–∞—á—É:
            [json]{{"actions":[{{"intent":"add_task","data":{{"task":"–∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ"}}}}]}}[/json]

            2. –î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á:
            [json]{{"actions":[
                {{"intent":"add_task","data":{{"task":"—Ö–ª–µ–±"}}}},
                {{"intent":"add_task","data":{{"task":"–ø–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ","priority":1}}}},
                {{"intent":"add_task","data":{{"task":"–æ–ø–ª–∞—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç","deadline":"–∑–∞–≤—Ç—Ä–∞"}}}}
            ]}}[/json]

            3. –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π:
            [json]{{"actions":[{{"intent":"complete_task","data":{{"task_text":"–æ—Ç—á–µ—Ç"}}}}]}}[/json]

            4. –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É:
            [json]{{"actions":[{{"intent":"delete_task","data":{{"task_id":5}}}}]}}[/json]

            5. –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É (–ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç):
            [json]{{"actions":[{{"intent":"update_task","data":{{
                "task_id":5,
                "task_text":"–∫—É–ø–∏—Ç—å —Ö–ª–µ–± –∏ –º–æ–ª–æ–∫–æ",
                "priority":1,
                "deadline":"2025-02-20",
                "status":0,
                "progress_context":"–≤ –º–∞–≥–∞–∑–∏–Ω–µ —É–∂–µ"
            }}}}]}}[/json]

            6. –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ:
            [json]{{"actions":[{{"intent":"show_task_info","data":{{"task_text":"–æ—Ç—á–µ—Ç"}}}}]}}[/json]

            7. –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç:
            [json]{{"actions":[{{"intent":"show_context","data":{{"task_id":5}}}}]}}[/json]

            8. –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏:
            [json]{{"actions":[{{"intent":"show_tasks","data":{{}}}}]}}[/json]

            9. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
            [json]{{"actions":[{{"intent":"stats","data":{{}}}}]}}[/json]

            10. –ß–∞—Ç (–Ω–µ –ø–æ –∑–∞–¥–∞—á–∞–º):
            [json]{{"actions":[{{"intent":"chat","data":{{"response":"—Ç–≤–æ–π –æ—Ç–≤–µ—Ç"}}}}]}}[/json]

            11. –°–º–µ—à–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
            [json]{{"actions":[
                {{"intent":"add_task","data":{{"task":"–º–æ–ª–æ–∫–æ"}}}},
                {{"intent":"complete_task","data":{{"task_text":"–æ—Ç—á–µ—Ç"}}}},
                {{"intent":"show_tasks","data":{{}}}}
            ]}}[/json]

            12. –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Å–µ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º 2):
            [json]{{"actions":[
                {{"intent":"delete_task","data":{{"task_id":3}}}},
                {{"intent":"delete_task","data":{{"task_id":7}}}},
                {{"intent":"delete_task","data":{{"task_id":12}}}}
            ]}}[/json]

            ========== –°–¢–†–£–ö–¢–£–†–ê –ë–ê–ó–´ –î–ê–ù–ù–´–• (–¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è) ==========
            –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ data:
            - id (INTEGER) - –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
            - user_id (BIGINT) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            - task_text (TEXT) - —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è add_task)
            - deadline (TIMESTAMP) - –¥–µ–¥–ª–∞–π–Ω –∑–∞–¥–∞—á–∏
            - priority (INTEGER) - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: 1 (–≤—ã—Å–æ–∫–∏–π), 2 (—Å—Ä–µ–¥–Ω–∏–π), 3 (–Ω–∏–∑–∫–∏–π)
            - status (INTEGER) - —Å—Ç–∞—Ç—É—Å: 1 (–Ω–µ —Å–¥–µ–ª–∞–Ω–æ), 0 (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ), -1 (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
            - progress_context (TEXT) - –∫–æ–Ω—Ç–µ–∫—Å—Ç/–ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–¥–∞—á–∏
            - created_at (TIMESTAMP) - –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
            - completed_at (TIMESTAMP) - –¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

            ========== –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ ==========
            –ü–æ—Å–ª–µ JSON –Ω–∞–ø–∏—à–∏ –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:

            1. –°–ù–ê–ß–ê–õ–ê –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
            2. –ü–û–¢–û–ú –ø–æ–∫–∞–∂–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–ª–∏ –±—ã–ª–æ show_tasks)
            3. –ò–°–ü–û–õ–¨–ó–£–ô –≠–ú–û–î–ó–ò –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
            4. –ù–ò–ö–ê–ö–û–ì–û MARKDOWN - —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –∏ —ç–º–æ–¥–∑–∏
            5. –ù–ò–ö–ê–ö–ò–• ID –∑–∞–¥–∞—á –≤ –æ—Ç–≤–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            6. –î–†–£–ñ–ï–õ–Æ–ë–ù–´–ô —Ç–æ–Ω

            –®–ê–ë–õ–û–ù –î–õ–Ø –°–ü–ò–°–ö–ê –ó–ê–î–ê–ß:
            –¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á:
            üî• –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1):
            ‚Ä¢ –∑–∞–¥–∞—á–∞ 1
            ‚Ä¢ –∑–∞–¥–∞—á–∞ 2

            üìä –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (2):
            ‚Ä¢ –∑–∞–¥–∞—á–∞ 3
            ‚Ä¢ –∑–∞–¥–∞—á–∞ 4

            üå± –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (3):
            ‚Ä¢ –∑–∞–¥–∞—á–∞ 5

            –ü–†–ò–ú–ï–† –ü–û–õ–ù–û–ì–û –û–¢–í–ï–¢–ê:
            ‚úÖ –î–æ–±–∞–≤–∏–ª –∑–∞–¥–∞—á—É "–∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ"
            ‚úÖ –û—Ç–º–µ—Ç–∏–ª "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç" –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ

            –¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á:
            üî• –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1):
            ‚Ä¢ –ø–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ

            üìä –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (2):
            ‚Ä¢ –∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ
            ‚Ä¢ –æ–ø–ª–∞—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç

            üå± –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (3):
            ‚Ä¢ —É–±—Ä–∞—Ç—å—Å—è –≤ –∫–æ–º–Ω–∞—Ç–µ
            –ù–ï –û–ë–û–†–ê–ß–ò–í–ê–ô JSON –û–¢–í–ï–¢ –í –¢–†–û–ô–ù–´–ï –°–ö–û–ë–ö–ò
            ========== –¢–í–û–ô –û–¢–í–ï–¢ (JSON + –¢–ï–ö–°–¢) ==========
            """
            print("üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –≤ DeepSeek...")
            full_response = self.ds.generate_response(unified_prompt)

            # –ü–∞—Ä—Å–∏–º JSON —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏
            json_match = re.search(r'\[json\](.*?)\[/json\]', full_response, re.DOTALL)
            if json_match:
                try:
                    actions_data = json.loads(json_match.group(1))
                    actions = actions_data.get("actions", [])

                    print(f"üìã –ü–æ–ª—É—á–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è: {actions}")

                    # –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
                    for action in actions:
                        intent = action.get("intent")
                        data = action.get("data", {})

                        if intent == 'add_task':
                            task_text = data.get("task")
                            deadline = data.get("deadline")
                            priority = int(data.get("priority", 2))
                            self.db.add_task(user_id, task_text, priority=priority, deadline=deadline)
                            print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞: {task_text}")

                        elif intent == 'complete_task':
                            task_text = data.get("task_text")
                            task_id = data.get("task_id")
                            result = self.db.complete_task(user_id, task_id=task_id, task_text=task_text)
                            print(f"‚úÖ –ó–∞–¥–∞—á–∞ –æ—Ç–º–µ—á–µ–Ω–∞: {result}")


                        elif intent == 'delete_task':
                            task_text = data.get("task_text")
                            task_id = data.get("task_id")
                            print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏: {task_text or task_id}")
                            result = self.db.delete_task(user_id, task_id=task_id, task_text=task_text)
                            if result:
                                print(f"‚úÖ –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞")
                            else:
                                print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–¥–∞—á—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è")



                        elif intent == 'update_task':
                            task_id = data.get("id")  # –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ - DeepSeek –≤–µ—Ä–Ω—É–ª "id", –∞ –Ω–µ "task_id"!
                            task_text = data.get("task_text")
                            # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è - –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
                            new_task = {k: v for k, v in data.items() if k not in ['id', 'task_text']}
                            print(f"üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏: {task_text or task_id}")
                            print(f"üìù –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: {new_task}")
                            result = self.db.update_task(
                                user_id,
                                task_id=task_id,
                                task_text=task_text,
                                new_task=new_task
                            )
                            if result:
                                print(f"‚úÖ –ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
                            else:
                                print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É")
                        elif intent == 'show_tasks':
                            print("üìã –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∫–∞–∑ –∑–∞–¥–∞—á")

                except Exception as e:
                    print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")

            # –£–±–∏—Ä–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

            clean_response = re.sub(r'\[json\].*?\[/json\]', '', full_response, flags=re.DOTALL).replace('[json]', '').replace('[/json]', '')
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            self.bot.reply_to(message, clean_response, parse_mode=None)
            print("‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")

    def run(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...")
        try:
            self.bot.infinity_polling()
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
        finally:
            print("üõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


if __name__ == "__main__":
    bot = TaskBot()
    bot.run()
